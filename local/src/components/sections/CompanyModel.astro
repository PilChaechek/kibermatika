---
import { Image } from "astro:assets";
import Astronaut from "../../assets/images/orbit/astronaut.png";
import Station from "../../assets/images/orbit/s2.png";
import Badge from "../../assets/images/badges/hands1.png";
---

<section class="section company-model">
    <div class="company-model__inner">
        <div class="container">
            <div class="company-model__header section__header">
                <div class="company-model__header-badge">
                    <div class="icon-badge icon-badge--v2">
                        <div class="icon-badge__icon">
                            <div class="icon-badge__icon-wrp">
                                <Image
                                    src={Badge}
                                    alt=""
                                    format="webp"
                                    quality={90}
                                    class="img icon-badge__icon-src pulse"
                                />
                            </div>
                        </div>
                        <div class="icon-badge__text">
                            строим всё <br /> вокруг продаж
                        </div>
                    </div>
                </div>
                <h2 class="section__title">Сейлзово-центричная компания</h2>
                <p class="company-model__header-text">
                    Мы вывернули систему управления наизнанку. Менеджер по
                    продажам <br /> становится первым человеком в компании после клиента.
                    Энергия <br /> активных продаж — наш драйвер, и каждый отдел построен
                    вокруг нее.
                </p>
            </div>
        </div>

        <div class="company-model__orbit">
            <div class="orbit">
                <div class="js-circle orbit-s3" data-index="3"></div>
                <div class="orbit-badge orbit-badge--1">
                    Менеджеры <br />по продажам
                </div>
                <div
                    class="orbit__item orbit__item--1 js-circle"
                    data-index="1"
                >
                    <div
                        class="orbit__item orbit__item--2 js-circle"
                        data-index="2"
                    >
                        <div class="orbit__item orbit__item--3">
                            <div class="orbit-badge orbit-badge--2">
                                Клиент и продажи
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="orbit-stream">
                <div class="orbit-box orbit-box--1">
                    <div class="orbit-box__header">
                        <div class="orbit-box__title">
                            Поддержка <br /> и система
                        </div>
                    </div>
                    <div class="orbit-box__content">
                        <ul class="orbit-box__list list list-marker">
                            <li>IT-support</li>
                            <li>Отдел контроля качества</li>
                            <li>Разработка</li>
                        </ul>
                    </div>
                </div>

                <div class="orbit-box orbit-box--2">
                    <div class="orbit-box__header">
                        <div class="orbit-box__title">
                            Среда <br /> и ресурсы
                        </div>
                    </div>
                    <div class="orbit-box__content">
                        <ul class="orbit-box__list list list-marker">
                            <li>Высокий % и амбициозный уровень дохода</li>
                            <li>База знаний</li>
                            <li>Качественные лиды</li>
                            <li>Удобная CRM</li>
                            <li>Отсутсвие начальников-дураков</li>
                            <li>Поддержка команды и фидбэк-сессии</li>
                        </ul>
                    </div>
                </div>

                <div class="orbit-box orbit-box--3">
                    <div class="orbit-box__header">
                        <div class="orbit-box__title">CEO и СТО</div>
                    </div>
                    <div class="orbit-box__content">
                        <ul class="orbit-box__list list list-marker">
                            <li>
                                Открытая связь, готовность к новым идеям и
                                изменениям
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="company-model__footer">
            <a
                href="https://spb.hh.ru/employer/5471863?hhtmFrom=vacancy"
                target="_blank"
                class="btn btn--main">Присоединиться к команде</a
            >
        </div>
    </div>
</section>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    // --- Логика Скролла ---
    function initStreamScroll() {
        const section = document.querySelector(".company-model");
        const inner = document.querySelector(".company-model__inner");
        const stream = document.querySelector(".orbit-stream");

        if (!section || !stream || !inner) return;

        let mm = gsap.matchMedia();

        mm.add("(max-width: 745px)", (context) => {
            const streamHeight = stream.scrollHeight;
            const windowHeight = window.innerHeight;
            const trackHeight = streamHeight * 0.8 + windowHeight * 1.0;

            gsap.set(section, { height: trackHeight, position: "relative" });
            gsap.set(inner, {
                position: "sticky",
                top: 0,
                overflow: "hidden",
                zIndex: 2,
            });
            gsap.set(stream, { force3D: false, willChange: "transform" });

            gsap.fromTo(
                stream,
                { y: windowHeight },
                {
                    y: -streamHeight,
                    ease: "none",
                    scrollTrigger: {
                        trigger: section,
                        start: "top top",
                        end: "bottom bottom",
                        scrub: 1.1,
                        pin: false,
                        invalidateOnRefresh: true,
                        onUpdate: (self) => {
                            const header =
                                section.querySelector(".section__header");
                            const orbit = section.querySelector(".orbit");
                            const isBlur =
                                self.progress > 0.1 && self.progress < 0.95;

                            if (header) {
                                header.classList.toggle(
                                    "section__header--blur",
                                    isBlur,
                                );
                            }
                            if (orbit) {
                                orbit.classList.toggle("orbit--blur", isBlur);
                            }
                        },
                    },
                },
            );
        });
    }

    // --- Логика Ховера ---
    function initOrbitHover() {
        const container = document.querySelector(".company-model");
        const circles = document.querySelectorAll(".js-circle");

        if (!container || circles.length === 0) return;

        circles.forEach((circle) => {
            circle.addEventListener("mouseover", (e) => {
                e.stopPropagation(); // Важно для вложенных кругов
                const index = circle.dataset.index;
                container.classList.remove(
                    "company-model--1",
                    "company-model--2",
                    "company-model--3",
                );
                container.classList.add(`company-model--${index}`);
            });

            circle.addEventListener("mouseout", (e) => {
                e.stopPropagation();
                const index = circle.dataset.index;
                container.classList.remove(`company-model--${index}`);
            });
        });
    }

    // Запуск всего
    document.addEventListener("DOMContentLoaded", () => {
        initStreamScroll();
        initOrbitHover();
    });
</script>
