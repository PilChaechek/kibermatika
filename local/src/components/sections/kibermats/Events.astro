---
import Badge from "../../../assets/images/badges/hands2.png";
import img1 from "../../../assets/images/events/1.webp";
import img2 from "../../../assets/images/events/2.webp";
import img3 from "../../../assets/images/events/3.webp";
import img4 from "../../../assets/images/events/4.webp";
import {Image} from "astro:assets";
const items = [
    {
        title: 'GRANI FESTIVAL',
        text: 'Первый drum\'n\'bass фестиваль <br> с симфоническим оркестром в России',
        category: 'Музыка',
        img: img1,
        video: 'https://kinescope.io/embed/o2VSMBcg6GT3RT7z246RbP'
    },
    {
        title: 'Киберматика трофи',
        text: 'Гонки на внедорожниках по Подмосковью',
        category: 'Экстрим',
        img: img2,
        video: false
    },
    {
        title: 'Героическая стратсессия',
        text: 'Планирование бизнеса по методике режиссера «Рик и Морти»',
        category: 'Обучение',
        img: img3,
        video: false
    },
    {
        title: 'ИГРИСТАЯ',
        text: 'Музыкальная и перформанс-площадка на фестивале SYSTO',
        category: 'Музыка',
        img: img4,
        video: 'https://kinescope.io/embed/qnoqDS9mQnvyPtF8LvwgFB'
    },
];
---
<section class="section events section--v9">
    <div class="container">
        <div class="events__inner">
            <div class="events__header">
                <div class="slider__header">
                    <div class="slider__badge">
                        <div class="icon-badge icon-badge--v3">
                            <div class="icon-badge__icon">
                                <img src={Badge.src} class="img icon-badge__icon-src icon-badge__icon-src--w" alt="" width="88" height="88">
                            </div>
                            <div class="icon-badge__text">не только<br> про работу</div>
                        </div>
                    </div>
                    <h2 class="slider__title section__title">Творчество<br>  во всех проявлениях</h2>
                    <p class="slider__text">Наше желание создавать выходит
                        за пределы B2B-продуктов и IT-сферы. Музыка, фестивали и события — разносторонний опыт для себя и других.</p>
                </div>
            </div>
            <div class="events__items">
                {items.map(item => (
                    <div class="event-card" style={{ backgroundImage: `url(${item.img.src})` }} data-video={item.video}>
                        <div class="event-card__inner">
                            <div class="event-card__category">{item.category}</div>
                            {item.video && (
                                <button type="button" class="event-card__btn-play btn-reset btn-play">
                                    <svg width="44" height="45" viewBox="0 0 44 45" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M40.7747 26.1203C43.8262 24.5237 43.8262 20.156 40.7747 18.5594L6.24469 0.492477C3.40388 -0.9939 0 1.06677 0 4.27293V40.4068C0 43.6129 3.40388 45.6736 6.24469 44.1872L40.7747 26.1203Z" fill="white" />
                                    </svg>
                                </button>
                            )}
                            <h3 class="event-card__title">{item.title}</h3>
                            <div class="event-card__text" set:html={item.text}/>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const eventCards = document.querySelectorAll('.event-card');

        eventCards.forEach(card => {
            card.addEventListener('click', function(e) {
                const videoUrl = this.dataset.video;
                if (!videoUrl || videoUrl === 'false') return;

                // Находим и сбрасываем предыдущее активное видео
                const currentActiveCard = document.querySelector('.event-card.event-card--play');
                if (currentActiveCard && currentActiveCard !== this) {
                    const oldIframe = currentActiveCard.querySelector('iframe');
                    if (oldIframe) {
                        oldIframe.remove();
                    }
                    currentActiveCard.classList.remove('event-card--play');
                }

                // Если текущая карточка уже играет, просто возвращаемся (для предотвращения перезагрузки)
                if (this.classList.contains('event-card--play')) {
                    return;
                }

                const iframe = document.createElement('iframe');
                // Добавляем параметр autoplay, если его нет
                const finalUrl = videoUrl.includes('?') ? `${videoUrl}&autoplay=1` : `${videoUrl}?autoplay=1`;
                
                iframe.setAttribute('src', finalUrl);
                iframe.setAttribute('frameborder', '0');
                iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
                iframe.setAttribute('allowfullscreen', 'true');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.position = 'absolute';
                iframe.style.top = '0';
                iframe.style.left = '0';

                this.appendChild(iframe);
                this.classList.add('event-card--play');
            });
        });
    });
</script>